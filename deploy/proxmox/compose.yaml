services:
  lgtm:
    image: grafana/otel-lgtm:0.11.17
    ports:
      - "3000:3000"
      - "4317:4317"
      - "4318:4318"
      - "4040:4040"
      - "9090:9090"
      - "9010:9009"
    volumes:
      - ./data/lgtm:/data
      - ../grafana/provisioning/dashboards/smart-address.yaml:/otel-lgtm/grafana/conf/provisioning/dashboards/smart-address.yaml:ro
      - ../grafana/dashboards:/otel-lgtm/grafana/conf/provisioning/dashboards/smart-address:ro
    restart: unless-stopped

  smart-address:
    build:
      context: ../..
      dockerfile: Dockerfile
    image: smart-address-service
    ports:
      - "8787:8787"
    environment:
      SMART_ADDRESS_OTEL_ENABLED: "true"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://lgtm:4318"
      OTEL_SERVICE_NAME: "smart-address-service"
      OTEL_SERVICE_VERSION: "${OTEL_SERVICE_VERSION:-}"
      SMART_ADDRESS_DB_PATH: "/app/data/smart-address.db"
      NOMINATIM_USER_AGENT: "${NOMINATIM_USER_AGENT:-smart-address-service}"
      NOMINATIM_EMAIL: "${NOMINATIM_EMAIL:-}"
      RADAR_API_KEY: "${RADAR_API_KEY:-}"
      RADAR_AUTOCOMPLETE_BASE_URL: "${RADAR_AUTOCOMPLETE_BASE_URL:-}"
      RADAR_AUTOCOMPLETE_DEFAULT_LIMIT: "${RADAR_AUTOCOMPLETE_DEFAULT_LIMIT:-}"
      RADAR_AUTOCOMPLETE_LAYERS: "${RADAR_AUTOCOMPLETE_LAYERS:-}"
      RADAR_AUTOCOMPLETE_NEAR: "${RADAR_AUTOCOMPLETE_NEAR:-}"
      RADAR_AUTOCOMPLETE_COUNTRY_CODE: "${RADAR_AUTOCOMPLETE_COUNTRY_CODE:-}"
      RADAR_AUTOCOMPLETE_RATE_LIMIT_MS: "${RADAR_AUTOCOMPLETE_RATE_LIMIT_MS:-}"
      HERE_API_KEY: "${HERE_API_KEY:-}"
      HERE_DISCOVER_BASE_URL: "${HERE_DISCOVER_BASE_URL:-}"
      HERE_DISCOVER_DEFAULT_LIMIT: "${HERE_DISCOVER_DEFAULT_LIMIT:-}"
      HERE_DISCOVER_LANGUAGE: "${HERE_DISCOVER_LANGUAGE:-}"
      HERE_DISCOVER_IN_AREA: "${HERE_DISCOVER_IN_AREA:-}"
      HERE_DISCOVER_AT: "${HERE_DISCOVER_AT:-}"
      HERE_DEFAULT_LAT: "${HERE_DEFAULT_LAT:-}"
      HERE_DEFAULT_LNG: "${HERE_DEFAULT_LNG:-}"
      HERE_DISCOVER_RATE_LIMIT_MS: "${HERE_DISCOVER_RATE_LIMIT_MS:-}"
    volumes:
      - ./data/smart-address:/app/data
    restart: unless-stopped
    depends_on:
      - lgtm

  alloy:
    image: grafana/alloy:v1.12.2
    command:
      - run
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
      - /etc/alloy/config.alloy
    # Set ALLOY_UID/ALLOY_GID to run as non-root; root is the default fallback.
    user: "${ALLOY_UID:-0}:${ALLOY_GID:-0}"
    # Capabilities required for eBPF profiling + network tracing.
    cap_add:
      - SYS_ADMIN
      - SYS_RESOURCE
      - SYS_PTRACE
      - NET_ADMIN
      - NET_RAW
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    # Host PID namespace is required for eBPF profiling. Remove if eBPF is disabled.
    pid: "host"
    ports:
      - "12345:12345"
    volumes:
      - ../alloy/config.alloy:/etc/alloy/config.alloy:ro
      # For least privilege, point SMART_ADDRESS_DOCKER_SOCKET at a socket proxy.
      # Default docker.sock grants broad daemon access; prefer a socket proxy and set SMART_ADDRESS_DOCKER_SOCKET.
      - ${SMART_ADDRESS_DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock
      - ./data/alloy:/var/lib/alloy/data
      - ./data/symb-cache:/tmp/symb-cache
    depends_on:
      - lgtm
      - smart-address
    restart: unless-stopped
